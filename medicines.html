<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicines - Hospital Management System</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container navbar-content">
            <a href="index.html" class="navbar-brand">Hospital Management</a>
            <ul class="navbar-menu">
                <li><a href="index.html">Dashboard</a></li>
                <li><a href="patients.html">Patients</a></li>
                <li><a href="doctors.html">Doctors</a></li>
                <li><a href="appointments.html">Appointments</a></li>
                <li><a href="billing.html">Billing</a></li>
                <li><a href="medicines.html">Medicines</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header flex-between">
                <div>
                    <h1 class="page-title">Medicine Inventory</h1>
                    <p class="page-subtitle">Manage medicine stock and prescriptions</p>
                </div>
                <button class="btn btn-primary" onclick="showAddModal()">
                    + Add New Medicine
                </button>
            </div>

            <!-- Low Stock Alert -->
            <div id="lowStockAlert" class="card" style="display: none; border-left: 4px solid #f5576c;">
                <div class="card-body">
                    <h3 style="color: #f5576c; margin: 0 0 0.5rem 0;">⚠️ Low Stock Alert</h3>
                    <p id="lowStockMessage" style="margin: 0;"></p>
                </div>
            </div>

            <!-- Medicines Table -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">All Medicines</h2>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Medicine Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="medicinesTable">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Medicine Modal -->
    <div id="medicineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New Medicine</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="medicineForm" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label class="form-label">Medicine Name *</label>
                    <input type="text" name="medicine_name" class="form-control" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <input type="text" name="category" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Price *</label>
                        <input type="number" name="price" class="form-control" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Stock Quantity *</label>
                    <input type="number" name="stock_quantity" class="form-control" min="0" required>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Medicine</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Prescribe Medicine Modal -->
    <div id="prescribeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Prescribe Medicine</h2>
                <button class="modal-close" onclick="closePrescribeModal()">&times;</button>
            </div>
            <form id="prescribeForm" onsubmit="handlePrescribe(event)">
                <input type="hidden" name="medicine_id" id="prescribeMedicineId">
                <div class="form-group">
                    <label class="form-label">Patient *</label>
                    <select name="patient_id" id="patientSelect" class="form-control form-select" required>
                        <option value="">Loading patients...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity *</label>
                    <input type="number" name="quantity" class="form-control" min="1" required>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closePrescribeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Prescribe</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        let currentMedicineId = null;

        // Load medicines
        async function loadMedicines() {
            try {
                const response = await MedicineAPI.getAll();
                const tbody = document.getElementById('medicinesTable');

                if (!response.data || response.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No medicines found</td></tr>';
                    return;
                }

                // Check for low stock
                const lowStock = response.data.filter(m => m.stock_quantity < 200);
                if (lowStock.length > 0) {
                    document.getElementById('lowStockAlert').style.display = 'block';
                    document.getElementById('lowStockMessage').textContent =
                        `${lowStock.length} medicine(s) are running low on stock!`;
                } else {
                    document.getElementById('lowStockAlert').style.display = 'none';
                }

                tbody.innerHTML = response.data.map(med => `
                    <tr>
                        <td>${med.medicine_id}</td>
                        <td><strong>${med.medicine_name}</strong></td>
                        <td>${med.category}</td>
                        <td>₹${med.price}</td>
                        <td>${med.stock_quantity}</td>
                        <td><span class="badge ${getStockBadge(med.stock_quantity)}">${getStockStatus(med.stock_quantity)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editMedicine(${med.medicine_id})">Edit</button>
                            <button class="btn btn-sm btn-success" onclick="prescribeMedicine(${med.medicine_id})">Prescribe</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMedicine(${med.medicine_id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showError('Failed to load medicines: ' + error.message);
            }
        }

        // Get stock status
        function getStockStatus(quantity) {
            if (quantity === 0) return 'Out of Stock';
            if (quantity < 100) return 'Critical';
            if (quantity < 200) return 'Low Stock';
            return 'In Stock';
        }

        // Get stock badge
        function getStockBadge(quantity) {
            if (quantity === 0) return 'badge-danger';
            if (quantity < 100) return 'badge-danger';
            if (quantity < 200) return 'badge-warning';
            return 'badge-success';
        }

        // Load patients for prescription
        async function loadPatients() {
            try {
                const response = await PatientAPI.getAll();
                const select = document.getElementById('patientSelect');
                select.innerHTML = '<option value="">Select Patient</option>' +
                    response.data.map(p => `<option value="${p.patient_id}">${p.name}</option>`).join('');
            } catch (error) {
                showError('Failed to load patients: ' + error.message);
            }
        }

        // Show add modal
        function showAddModal() {
            currentMedicineId = null;
            document.getElementById('modalTitle').textContent = 'Add New Medicine';
            document.getElementById('medicineForm').reset();
            document.getElementById('medicineModal').classList.add('active');
        }

        // Edit medicine
        async function editMedicine(id) {
            try {
                const response = await MedicineAPI.getById(id);
                const med = response.data;

                currentMedicineId = id;
                document.getElementById('modalTitle').textContent = 'Edit Medicine';

                const form = document.getElementById('medicineForm');
                form.medicine_name.value = med.medicine_name;
                form.category.value = med.category;
                form.price.value = med.price;
                form.stock_quantity.value = med.stock_quantity;

                document.getElementById('medicineModal').classList.add('active');
            } catch (error) {
                showError('Failed to load medicine data: ' + error.message);
            }
        }

        // Prescribe medicine
        function prescribeMedicine(id) {
            document.getElementById('prescribeMedicineId').value = id;
            document.getElementById('prescribeForm').reset();
            document.getElementById('prescribeModal').classList.add('active');
            loadPatients();
        }

        // Delete medicine
        async function deleteMedicine(id) {
            if (!confirmAction('Are you sure you want to delete this medicine?')) {
                return;
            }

            try {
                await MedicineAPI.delete(id);
                showSuccess('Medicine deleted successfully');
                loadMedicines();
            } catch (error) {
                showError('Failed to delete medicine: ' + error.message);
            }
        }

        // Handle form submit
        async function handleSubmit(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            try {
                if (currentMedicineId) {
                    await MedicineAPI.update(currentMedicineId, data);
                    showSuccess('Medicine updated successfully');
                } else {
                    await MedicineAPI.create(data);
                    showSuccess('Medicine added successfully');
                }

                closeModal();
                loadMedicines();
            } catch (error) {
                showError('Failed to save medicine: ' + error.message);
            }
        }

        // Handle prescribe
        async function handlePrescribe(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const data = {
                patient_id: formData.get('patient_id'),
                quantity: formData.get('quantity')
            };

            try {
                await MedicineAPI.prescribe(data);
                showSuccess('Medicine prescribed successfully');
                closePrescribeModal();
                loadMedicines();
            } catch (error) {
                showError('Failed to prescribe medicine: ' + error.message);
            }
        }

        // Close modals
        function closeModal() {
            document.getElementById('medicineModal').classList.remove('active');
        }

        function closePrescribeModal() {
            document.getElementById('prescribeModal').classList.remove('active');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMedicines();

            // Close modals on outside click
            document.getElementById('medicineModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) closeModal();
            });
            document.getElementById('prescribeModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) closePrescribeModal();
            });
        });
    </script>
</body>


</html>
